---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by declanchen.
--- DateTime: 2018/4/25 20:46
---

require("Lua520FestivityDoc.lua")

---@class Lua520FestivityRankDlg
Lua520FestivityRankDlg = {}
local this = Lua520FestivityRankDlg

---@type UnityEngine.GameObject
local selfObj = nil

---@type UnityEngine.Transform
local selfTrans = nil

---@type UnityEngine.GameObject
local closeBtnObj = nil

--标签页池
local m_TabPool

--回头根据配表走
local rankRewardTitleStr = "奖励"
local activityEndTimeStr = "活动结束：2018年6月22日23:59"
local rankRewardTips = "服务器前十名的玩家将获得专属奖励哦，活动结束后以邮件形式发送"
local tab1Str = "个人奖励"
local tab2Str = "排名奖励"

--排行奖励界面的 UILabel
local titleLb = nil
local ActivityEndTimeLb = nil
local tipsLb = nil

---@type UnityEngine.Transform
local TabsTrans = nil

---@type UnityEngine.GameObject
local PersonRewardPanelObj = nil

---@type UnityEngine.GameObject
local RankRewardPanelObj = nil

---@type UnityEngine.GameObject
local CurrSelectedTab = nil

---@type NGUI.UIScorllView
local p_ScrollView = nil
---@type UnityEngine.GameObject
local p_WrapContent = nil
local person_Pool = nil

---@type NGUI.UIScorllView
local r_ScrollView = nil
---@type UnityEngine.GameObject
local r_WrapContent = nil
local rank_Pool = nil

---@type UnityEngine.Transform
local itemTplRootTrans = nil
local rewardItemPool = nil

---@type UnityEngine.GameObject
local CurrLoveObj = nil
local CurrLoveValueLb = nil
---@type UnityEngine.GameObject
local CurrRankObj = nil
local CurrRankValueLb = nil

function Lua520FestivityRankDlg.Init()
    if IsNil(selfObj) or IsNil(selfTrans) then
        return
    end

    activityEndTimeStr = Hotfix.GetStringTable("LoveActivityTime")
    rankRewardTips = Hotfix.GetStringTable("rewardMailTips")

    CurrRankObj = selfTrans:Find("Bg2/Time (1)").gameObject
    CurrRankValueLb = CurrRankObj:GetComponent("UILabel")
    CurrLoveObj = selfTrans:Find("Bg2/Time (2)").gameObject
    CurrLoveValueLb = CurrLoveObj:GetComponent("UILabel")

   
    CurrSelectedTab = nil

    closeBtnObj = selfTrans:Find("Close").gameObject

    if not IsNil(closeBtnObj) then
        Hotfix.SetClickCallback(closeBtnObj, this.CloseBtnOnClick)
    end

    titleLb = selfTrans:Find("Tittle"):GetComponent("UILabel")

    ActivityEndTimeLb = selfTrans:Find("Bg2/Time"):GetComponent("UILabel")

    tipsLb = selfTrans:Find("Bg2/Intro"):GetComponent("UILabel")

    if not IsNil(titleLb) then
        titleLb.text = rankRewardTitleStr
    end

    if not IsNil(ActivityEndTimeLb) then
        ActivityEndTimeLb.text = activityEndTimeStr
    end

    if not IsNil(tipsLb) then
        tipsLb.text = rankRewardTips
    end

    RankRewardPanelObj = selfTrans:Find("RankRewardPanel").gameObject

    --初始化标签页
    TabsTrans = selfTrans:Find("Tabs")
    if not IsNil(TabsTrans) then
        local tabTpl = TabsTrans:Find("TabTpl").gameObject
        for i = 0,1,1 do
            ---@type UnityEngine.GameObject
            local tempTabObj = GameObject.Instantiate(tabTpl)
            tempTabObj.transform.parent = TabsTrans
            tempTabObj.transform.localScale = Vector3.one
            local thePos = Vector3(i*140, 0, 0)
            tempTabObj.transform.localPosition = thePos

            local iSp = tempTabObj:GetComponent("XUISprite")
            iSp.ID = i

            local tabNameLb = tempTabObj.transform:Find("Text"):GetComponent("UILabel")
            local tabNameSelectLb = tempTabObj.transform:Find("SelectedText"):GetComponent("UILabel")

            if not IsNil(tabNameLb) then
                if i == 0 then
                    CurrSelectedTab = tempTabObj

                    tabNameLb.text = tab1Str
                    tabNameSelectLb.text = tab1Str
                elseif i == 1 then
                    tabNameLb.text = tab2Str
                    tabNameSelectLb.text = tab2Str
                end
            end

            Hotfix.SetClickCallback(tempTabObj, this.TabOnClick)
        end

        tabTpl:SetActive(false)
    end

    --初始化个人奖励ScrollView
    local PersonRewardPanelTrans = selfTrans:Find("PersonRewardPanel")
    PersonRewardPanelObj = PersonRewardPanelTrans.gameObject
    local PersonWrapTrans = PersonRewardPanelTrans:Find("WrapContent")
    p_ScrollView = PersonRewardPanelTrans:GetComponent("UIScrollView")
    p_WrapContent = PersonWrapTrans.gameObject

    if p_ScrollView ~= nil and p_WrapContent ~= nil then
        -- 初始化个人奖励对象池
        person_Pool = Hotfix.SetupPool(
                PersonRewardPanelObj,
                PersonWrapTrans:Find("Tpl").gameObject,
                6)
    end
    Hotfix.InitWrapContent(p_WrapContent, this.WrapContentPersonUpdated)


    --初始化排名奖励ScrollView
    local RankRewardPanelTrans = selfTrans:Find("RankRewardPanel")
    RankRewardPanelObj = RankRewardPanelTrans.gameObject
    local RankWrapTrans = RankRewardPanelTrans:Find("WrapContent")
    r_ScrollView = RankRewardPanelTrans:GetComponent("UIScrollView")
    r_WrapContent = RankWrapTrans.gameObject

    if r_ScrollView ~= nil and r_WrapContent ~= nil then
        -- 初始化排名奖励对象池
        rank_Pool = Hotfix.SetupPool(
                RankRewardPanelObj,
                RankWrapTrans:Find("Tpl").gameObject,
                6)
    end
    Hotfix.InitWrapContent(r_WrapContent, this.WrapContentRankUpdated)


    --初始化奖励item对象池
    itemTplRootTrans = selfTrans:Find("itemTplRoot")
    if not IsNil(itemTplRootTrans) then
        rewardItemPool = Hotfix.SetupPool(
                itemTplRootTrans.gameObject,
                itemTplRootTrans:Find("ItemTpl").gameObject,
                6
        )
    end

    this.RefreshAllScrollView()

    this.TabOnClick(CurrSelectedTab)
end

---@param rootTrans UnityEngine.Transform
function Lua520FestivityRankDlg.refreshAllChild(childCount, rootTrans, itemTable, func)

    local childCount = rootTrans.childCount

    for i = 0 , childCount - 1 do
        local tempTrans = rootTrans:Find("item"..tostring(i))
        if tempTrans ~= nil then
            local index =(i + 1 )
            func(itemTable,tempTrans.gameObject,index)
        end
    end
end

---@param tempObj UnityEngine.GameObject
function Lua520FestivityRankDlg.DoItemDisplay(itemTable,tempObj,index)
    local index = (index - 1) * 2 + 1

    --print "-------------------------"
    local data1 = itemTable[index]
    --print ("data1: "..data1)
    local data2 = itemTable[index + 1]
    --print ("data2: "..data2)
    tempObj:SetActive(true)
    Hotfix.DrawItemView(tempObj,data1,data2,true)

    local ispObj = tempObj.transform:Find("Icon").gameObject
    local isp = ispObj:GetComponent("XUISprite")
    isp.ID = data1
    Hotfix.SetClickCallback(ispObj,this.smallItemTipDlg)
end


---@param t UnityEngine.Transform
function Lua520FestivityRankDlg.WrapContentPersonUpdated(t,index)

    local btnTrans = t:Find("Btn")
    if not IsNil(btnTrans) then
        btnTrans.gameObject:SetActive(false)
    end

    --print("the index: "..tostring(index))

    --dataCountdex为c#控件传来的数组下标从0开始，而lua里的table下标从1开始，故+1
    local tempdata = Lua520FestivityDoc.GetPersonRewardTable()[index + 1]

    local scoreLb = t:Find("Value"):GetComponent("UILabel")
    if not IsNil(scoreLb) then
        scoreLb.text = tostring(tempdata.LoveScore)
    end

    local itemRootTrans = t:Find("itemRoot")
    local childCount = itemRootTrans.childCount

    local theTableCount = #tempdata.LoveReward
    local tempDataCount =  theTableCount / 2

    if childCount ~= tempDataCount then
        if childCount > tempDataCount then
            for i=childCount,tempDataCount + 1, -1 do
                rewardItemPool:ReturnInstance(itemRootTrans:GetChild(i-1).gameObject, true)
            end

            this.refreshAllChild(childCount, itemRootTrans, tempdata.LoveReward, this.DoItemDisplay)
        else
            this.refreshAllChild(childCount, itemRootTrans, tempdata.LoveReward, this.DoItemDisplay)

            for i = childCount + 1, tempDataCount do
                local tempObj = rewardItemPool:FetchGameObject()
                tempObj.transform.parent = itemRootTrans
                tempObj.transform.localScale = Vector3.one
                tempObj.transform.localPosition = Vector3((i-1) * 80, 0, 0)

                this.DoItemDisplay(tempdata.LoveReward, tempObj, i)

            end
        end
    else
        this.refreshAllChild(childCount, itemRootTrans, tempdata.LoveReward, this.DoItemDisplay)
    end


end

function Lua520FestivityRankDlg.smallItemTipDlg(go)
    local isp = go:GetComponent("XUISprite")
    local itemid = isp.ID

    print("item id: "..itemid)

    Hotfix.LuaShowItemTooltipDialog(itemid, go)
end


---@param t UnityEngine.Transform
function Lua520FestivityRankDlg.WrapContentRankUpdated(t,index)

    --dataCountdex为c#控件传来的数组下标从0开始，而lua里的table下标从1开始，故+1
    local tempdata = Lua520FestivityDoc.GetRankRewardTable()[index + 1]

    local rankTable = tempdata.LoveRank

    local data1 = rankTable[1]
    local data2 = rankTable[2]

    local RankLb = t:Find("RankLb"):GetComponent("UILabel")

    if not IsNil(RankLb) then
        if data1 == data2 then
            RankLb.text = "第"..tostring(data1).."名"
        else
            RankLb.text = tostring(data1).."-"..tostring(data2)
        end
    end

    local theTitle = t:Find("Title"):GetComponent("UISprite")
    local theTitleStr = t:Find("TitleLb"):GetComponent("UILabel")

    theTitle.gameObject:SetActive(false)
    theTitleStr.gameObject:SetActive(false)

    if tempdata.DesignationId == 1 then
        theTitleStr.gameObject:SetActive(true)
    else
        theTitle.gameObject:SetActive(true)
        theTitle.spriteName = tempdata.DesignationIcon
    end

    local itemRootTrans = t:Find("itemRoot")
    local childCount = itemRootTrans.childCount

    local theTableCount = #tempdata.RankReward
    local tempDataCount =  theTableCount / 2

    if childCount ~= tempDataCount then
        if childCount > tempDataCount then
            for i=childCount,tempDataCount + 1, -1 do
                rewardItemPool:ReturnInstance(itemRootTrans:GetChild(i-1).gameObject, true)
            end

            this.refreshAllChild(childCount, itemRootTrans, tempdata.RankReward, this.DoItemDisplay)
        else
            this.refreshAllChild(childCount, itemRootTrans, tempdata.RankReward, this.DoItemDisplay)

            for i = childCount + 1, tempDataCount do
                local tempObj = rewardItemPool:FetchGameObject()
                tempObj.transform.parent = itemRootTrans
                tempObj.transform.localScale = Vector3.one
                tempObj.transform.localPosition = Vector3((i-1) * 80, 0, 0)

                this.DoItemDisplay(tempdata.RankReward, tempObj, i)
            end
        end
    else
        this.refreshAllChild(childCount, itemRootTrans, tempdata.RankReward, this.DoItemDisplay)
    end


end

function Lua520FestivityRankDlg.RefreshAllScrollView()

    local rankRewardTable = Lua520FestivityDoc.GetRankRewardTable()
    local rankTableCount = #rankRewardTable
    --print("rank count: "..rankTableCount)

    local personRewardTable = Lua520FestivityDoc.GetPersonRewardTable()
    local personTableCount = #personRewardTable
    --print("person count: "..personTableCount)

    Hotfix.SetWrapContentCount(p_WrapContent, personTableCount, false)
    Hotfix.SetWrapContentCount(r_WrapContent, rankTableCount, false)

    p_ScrollView:ResetPosition()
    r_ScrollView:ResetPosition()

end

function Lua520FestivityRankDlg.TabOnClick(go)
    local iSp = go:GetComponent("XUISprite")
    local theId = iSp.ID

    print("theId: "..theId)

    PersonRewardPanelObj:SetActive(false)
    CurrLoveObj:SetActive(false)

    RankRewardPanelObj:SetActive(false)
    CurrRankObj:SetActive(false)

    if not IsNil(CurrSelectedTab) then
        local theUnSelectObj = CurrSelectedTab.transform:Find("UnSelected").gameObject
        theUnSelectObj:SetActive(true)
    end

    CurrSelectedTab = go

    local theUnSelectObj = CurrSelectedTab.transform:Find("UnSelected").gameObject
    theUnSelectObj:SetActive(false)

    if theId == 0 then
        CurrLoveObj:SetActive(true)
        PersonRewardPanelObj:SetActive(true)
        rankRewardTips = Hotfix.GetStringTable("Onerank520Tips")

        elseif theId == 1 then
            CurrRankObj:SetActive(true)
            RankRewardPanelObj:SetActive(true)
            rankRewardTips = Hotfix.GetStringTable("rewardMailTips")
    end

    if not IsNil(tipsLb) then
        tipsLb.text = rankRewardTips
    end

end


function Lua520FestivityRankDlg.CloseBtnOnClick()
    LuaUIManager.Instance:Hide("UI/OperatingActivity/520FestivityRankDlg")
end

function Lua520FestivityRankDlg.OnShow()

    if not IsNil(CurrRankValueLb) then
        local theRankValue = Lua520FestivityDoc.GetMyRankValue()
        if theRankValue == 4294967295 then
            CurrRankValueLb.text = "未上榜"
        else
            CurrRankValueLb.text = "第"..tostring(theRankValue + 1).."名"
        end
    end

    if not IsNil(CurrLoveValueLb) then
        CurrLoveValueLb.text = "当前恋爱值："..tostring(Lua520FestivityDoc.GetMyCurLoveValue())
    end

end

function Lua520FestivityRankDlg.OnHide()

end

---------------------------------------------------- Unity MonoBehaviour 生命周期 -------------------------------------------------
function Lua520FestivityRankDlg.Awake(go)
    selfObj = go

    selfTrans = selfObj.transform

    this.Init()
end

function Lua520FestivityRankDlg.Start()

end

function Lua520FestivityRankDlg.OnEnable()

end

function Lua520FestivityRankDlg.OnDisable()

end

function Lua520FestivityRankDlg.OnDestroy()
    CurrSelectedTab = nil

    if not IsNil(rewardItemPool) then
        rewardItemPool:ReturnAllDisable()
        rewardItemPool = nil
    end

    if not IsNil(rank_Pool) then
        rank_Pool:ReturnAllDisable()
        rank_Pool = nil
    end

    if not IsNil(person_Pool) then
        person_Pool:ReturnAllDisable()
        person_Pool = nil
    end
end
