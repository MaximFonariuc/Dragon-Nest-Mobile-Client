---
--- Generated by EmmyLua(https://github.com/EmmyLua)
--- Created by declanchen.
--- DateTime: 2018/4/28 16:49
---

---宝箱物品列表预览视图类

require("LuaItemIconListData")

---@class LuaItemIconListDlgForLua
LuaItemIconListDlgForLua = {}
local this = LuaItemIconListDlgForLua

---@type UnityEngine.GameObject
local selfObj = nil

---@type UnityEngine.TransformN
local selfTrans = nil

---@type UnityEngine.GameObject
local closeBtnObj = nil

---@type UnityEngine.Transform
local ItemGridTrans = nil

---@type UnityEngine.Transform
local ArrowUpTrans = nil

---@type UnityEngine.Transform
local ArrowDownTrans = nil

---@type  UISprite   CSharp
local BgSpr = nil

---@type XUIPool    CSharp
local m_itemPool = nil

--背景单位长度
local BgNormal = 90

--背景长度比例单个物品默认比例为2，多一个物品比例为+1
local BgRatio = 2

function LuaItemIconListDlgForLua.Init()

    if IsNil(selfObj) or IsNil(selfTrans) then
        return
    end

    closeBtnObj = selfTrans:Find("Close").gameObject

    if not IsNil(closeBtnObj) then
        Hotfix.SetClickCallback(closeBtnObj, this.CloseBtnOnClick)
    end

    ArrowUpTrans = selfTrans:Find("Bg/ArrowUp")
    ArrowDownTrans = selfTrans:Find("Bg/ArrowDown")


    BgSpr = selfTrans:Find("Bg"):GetComponent("UISprite")

    ItemGridTrans = selfTrans:Find("Bg/ListPanel")

    local itemTplObj = selfTrans:Find("Bg/ItemTpl").gameObject

    if not IsNil(ItemGridTrans) then
        m_itemPool = Hotfix.SetupPool(
                selfTrans:Find("Bg").gameObject,
                itemTplObj,
                3)
    end

end

function LuaItemIconListDlgForLua.SetGlobalPosition()
    local targetPos = LuaItemIconListData.GetTargetPos()

    ---@type UnityEngine.Transform
    local BgSprTrans = BgSpr.transform
    BgSprTrans.position = targetPos

    local localBgPos = BgSprTrans.localPosition

    localBgPos.y = localBgPos.y - ( BgSpr.height / 2 + 50 )

    local Base_UI_Width =  Hotfix.GetSingleMember("XGameUI","Base_UI_Width",true,false,false)
    local Base_UI_Height = Hotfix.GetSingleMember("XGameUI","Base_UI_Height",true,false,false)
    local ValidRect_x =  - (Base_UI_Width - BgSpr.width) / 2
    local ValidRect_y =  - (Base_UI_Height - BgSpr.height) / 2
    local ValidRect_width = Base_UI_Width - BgSpr.width
    local ValidRect_height = Base_UI_Height - BgSpr.height

    local xMin = ValidRect_x
    local yMin = ValidRect_y
    local xMax = ValidRect_x + ValidRect_width
    local yMax = ValidRect_y + ValidRect_height


    ArrowUpTrans.gameObject:SetActive(false)
    ArrowDownTrans.gameObject:SetActive(false)

    ---@type UnityEngine.Transform
    local needShowArrowTrans = ArrowUpTrans

    --y超出下边界
    if localBgPos.y < yMin then
        localBgPos.y = BgSprTrans.localPosition.y + ( BgSpr.height / 2 + 50 )
        needShowArrowTrans = ArrowDownTrans
    end

    localBgPos.x = math.max(xMin,localBgPos.x)
    localBgPos.x = math.min(xMax,localBgPos.x)
    localBgPos.y = math.max(yMin,localBgPos.y)
    localBgPos.y = math.min(yMax,localBgPos.y)

    BgSprTrans.localPosition = localBgPos

    --箭头
    needShowArrowTrans.position = Vector3(targetPos.x, needShowArrowTrans.position.y, needShowArrowTrans.position.z)
    local arrowX = math.clamp(needShowArrowTrans.localPosition.x, -BgSpr.width/2 + 5, BgSpr.width/2 + 5)
    needShowArrowTrans.localPosition = Vector3(arrowX, needShowArrowTrans.localPosition.y, needShowArrowTrans.localPosition.z)
    needShowArrowTrans.gameObject:SetActive(true)
end

function LuaItemIconListDlgForLua.CloseBtnOnClick()
    LuaUIManager.Instance:Hide("UI/GameSystem/ItemIconListDlgForLua")
end

---@param rootTrans UnityEngine.Transform
function LuaItemIconListDlgForLua.refreshAllChild(childCount, rootTrans, itemTable, func)

    local childCount = rootTrans.childCount

    for i = 0 , childCount - 1 do
        local tempTrans = rootTrans:Find("item"..tostring(i))
        if tempTrans ~= nil then
            local index =(i + 1 )
            func(itemTable,tempTrans.gameObject,index)
        end
    end
end

---@param tempObj UnityEngine.GameObject
function LuaItemIconListDlgForLua.DoItemDisplay(itemTable,tempObj,index)
    local index = (index - 1) * 2 + 1

    print("index: "..tostring(index))
    print "-------------------------"

    if #itemTable == 0 then
        return
    end

    local data1 = itemTable[index]
    print ("data1: "..data1)
    local data2 = itemTable[index + 1]
    print ("data2: "..data2)
    tempObj:SetActive(true)
    Hotfix.DrawItemView(tempObj,data1,data2,true)
end


function LuaItemIconListDlgForLua.OnShow()
    local theTable = LuaItemIconListData.GetDataTable()
    print("thetable count: "..tostring(#theTable))

    local UIGridComp = nil
    if IsNil(ItemGridTrans) then
        return
    else
        UIGridComp = ItemGridTrans:GetComponent("UIGrid")
    end

    if IsNil(UIGridComp) then
        return
    end

    local theTableCount = #theTable
    local tempDataCount = theTableCount / 2
    BgRatio = tempDataCount  + 1
    local theBgWidth = BgRatio * BgNormal

    if not IsNil(BgSpr) then
        BgSpr.width = theBgWidth
    end

    local childCount = ItemGridTrans.childCount
    if childCount ~= tempDataCount then
        if childCount > tempDataCount then
            for i=childCount,tempDataCount + 1, -1 do
                m_itemPool:ReturnInstance(ItemGridTrans:GetChild(i-1).gameObject, true)
            end
        else
            for i = childCount + 1, tempDataCount do
                local tempObj = m_itemPool:FetchGameObject()
                tempObj.transform.parent = ItemGridTrans
            end
        end
    else
    end

    this.refreshAllChild(childCount, ItemGridTrans, theTable, this.DoItemDisplay)

    UIGridComp:Reposition()

    this.SetGlobalPosition()
end

function LuaItemIconListDlgForLua.OnHide()
    LuaItemIconListData.ClearAll()
end

---------------------------------------------------- Unity MonoBehaviour 生命周期 -------------------------------------------------
function LuaItemIconListDlgForLua.Awake(go)
    selfObj = go

    selfTrans = selfObj.transform

    this.Init()
end

function LuaItemIconListDlgForLua.Start()

end

function LuaItemIconListDlgForLua.OnEnable()

end

function LuaItemIconListDlgForLua.OnDisable()

end

function LuaItemIconListDlgForLua.OnDestroy()
    if not IsNil(m_itemPool) then
        m_itemPool:ReturnAllDisable()
        m_itemPool = nil
    end
end
